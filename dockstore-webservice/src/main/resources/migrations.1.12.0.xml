<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--
  ~    Copyright 2021 OICR
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd"
                   context="1.12.0">
    <changeSet author="ktran (generated)" id="addImageSpecifier">
        <addColumn tableName="image">
            <column name="specifier" type="varchar(255 BYTE)"/>
        </addColumn>
    </changeSet>

    <changeSet author="natalieperez (generated)" id="addAppTool">
        <createTable tableName="apptool">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="apptool_pkey"/>
            </column>
            <column name="author" type="VARCHAR(255)"/>
            <column name="conceptdoi" type="VARCHAR(255)"/>
            <column name="dbcreatedate" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="dbupdatedate" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="giturl" type="VARCHAR(255)"/>
            <column name="ispublished" type="BOOLEAN"/>
            <column name="lastmodified" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="lastupdated" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="licensename" type="VARCHAR(255)"/>
            <column name="orcidputcode" type="VARCHAR(255)"/>
            <column name="topicid" type="BIGINT"/>
            <column name="checkerid" type="BIGINT"/>
            <column name="descriptortype" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="n/a" name="descriptortypesubclass" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="forumurl" type="VARCHAR(256)"/>
            <column defaultValue="STUB" name="mode" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="organization" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="repository" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="sourcecontrol" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="workflowname" type="TEXT"/>
            <column name="actualdefaultversion" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="actualdefaultversion" baseTableName="apptool" constraintName="fk_defaultversion_apptool" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="workflowversion"/>
        <addUniqueConstraint columnNames="actualdefaultversion" constraintName="uk_actualdefaultversion_apptool" tableName="apptool"/>
        <addUniqueConstraint columnNames="checkerid" constraintName="uk_checkerid_apptool" tableName="apptool"/>
        <addForeignKeyConstraint baseColumnNames="checkerid" baseTableName="apptool" constraintName="fk_checkerid_apptool" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="workflow"/>
    </changeSet>
    <changeSet author="natalieperez (generated)" id="upgradeLiquibase">
        <dropIndex tableName="cloud_instance" indexName="unique_user_instances"/>
        <addUniqueConstraint columnNames="url, user_id, partner" constraintName="unique_user_instances" tableName="cloud_instance"/>
    </changeSet>
    <changeSet author="gluu (generated)" id="addCheckUrl">
        <addColumn tableName="version_metadata">
            <column name="publicaccessibletestparameterfile" type="bool"/>
        </addColumn>
    </changeSet>
    <changeSet id="calculatedChecksums" author="coverbeck">
        <sql dbms="postgresql">
            create extension if not exists pgcrypto;
            alter table sourcefile disable row level security;
        </sql>
        <dropColumn tableName="sourcefile" columnName="checksums"></dropColumn>
        <sql dbms="postgresql">
            alter table sourcefile add column sha256 text generated always as (digest(content, 'sha256')) stored;
        </sql>
        <sql dbms="postgresql">
            alter table sourcefile enable row level security;
        </sql>
    </changeSet>
    <changeSet author="natalieperez (generated)" id="unique_collection_display_names_per_org">
        <dropUniqueConstraint constraintName="uk_collDisplayName" tableName="collection"/>
        <sql dbms="postgresql">
            create unique index collection_displayname_index on collection (LOWER(displayname), organizationid);
        </sql>
    </changeSet>

    <changeSet author="svonworl" id="categories_new_feature">
        <addColumn tableName="organization">
            <column name="categorizer" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="collection">
            <column name="dtype" type="varchar(255)" defaultValue="Collection">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql dbms="postgresql">
            create unique index collection_categoryname_index on collection (LOWER(name)) where dtype = 'Category';
        </sql>
        <sql dbms="postgresql">
            insert into organization (name, displayname, description, status, categorizer, link, email, dbcreatedate, dbupdatedate) values ('dockstore', 'Dockstore', 'Each of this organization''s Collections is a Category.', 'HIDDEN', true, 'https://dockstore.org/', 'support@dockstore.org', LOCALTIMESTAMP, LOCALTIMESTAMP);
        </sql>
        <!-- Add a handful of key users to the dockstore org, rather than all admins, to avoid inadvertently binding test users to orgs, which interferes with existing integration tests. -->
        <sql dbms="postgresql">
            insert into organization_user (organizationid, userid, accepted, role) select (select id from organization where name = 'dockstore'), id, true, 'ADMIN' from enduser where username in ('dockstore-admin', 'gluu-oicr', 'coverbeck-adm');
        </sql>
    </changeSet>
</databaseChangeLog>
