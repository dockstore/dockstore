<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--
  ~    Copyright 2017 OICR
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd" context="1.4.0">
    <changeSet id="workflowWorkflownameConvertEmptyStringToNull" author="gluu">
        <update schemaName="public"
                tableName="workflow">
            <column name="workflowname"/>
            <where>workflowname = ''</where>
        </update>
    </changeSet>
    <changeSet id="addWorkflowWorkflownameNotEmptyConstraint" author="gluu" >
        <sql dbms="postgresql">
            ALTER TABLE workflow add constraint workflow_workflowname_notempty check (workflowname &lt;&gt; '')
        </sql>
    </changeSet>
    <changeSet author="agduncan" id="74274923472389478923">
        <addColumn tableName="workflow">
            <column name="sourcecontrol" type="text">
            </column>
        </addColumn>

        <sql dbms="postgresql">
            update workflow set sourcecontrol='GITHUB' where giturl like '%github%'
        </sql>

        <sql dbms="postgresql">
            update workflow set path = CONCAT('github.com/', path) where sourcecontrol='GITHUB'
        </sql>

        <sql dbms="postgresql">
            update workflow set sourcecontrol='BITBUCKET' where giturl like '%bitbucket%'
        </sql>

        <sql dbms="postgresql">
            update workflow set path = CONCAT('bitbucket.org/', path) where sourcecontrol='BITBUCKET'
        </sql>

        <sql dbms="postgresql">
            update workflow set sourcecontrol='GITLAB' where giturl like '%gitlab%'
        </sql>

        <sql dbms="postgresql">
            update workflow set path = CONCAT('gitlab.com/', path) where sourcecontrol='GITLAB'
        </sql>

        <addNotNullConstraint tableName="workflow" columnName="sourcecontrol"/>

        <sql dbms="postgresql">
            alter table workflow drop constraint if exists ukkprrtg54h6rjca5l1navospm8
        </sql>

        <sql dbms="postgresql">
            alter table workflow drop constraint if exists uk_kprrtg54h6rjca5l1navospm8
        </sql>


        <dropIndex indexName="full_workflow_name" tableName="workflow"/>

        <sql dbms="postgresql">
            create unique index if not exists full_workflow_name on workflow (sourcecontrol, organization, repository, workflowname) where workflowname is not null
        </sql>

        <dropIndex indexName="partial_workflow_name" tableName="workflow"/>

        <sql dbms="postgresql">
            create unique index if not exists partial_workflow_name on workflow (sourcecontrol, organization, repository) where workflowname is null
        </sql>
    </changeSet>

    <!-- odd, but required for starting workflow refresh from a clean db -->
    <changeSet author="dyuen" id="custom_tool_sequence1">
        <sql>alter sequence container_id_seq increment by 50</sql>
    </changeSet>
    <changeSet author="dyuen" id="custom_tag_sequence2">
        <sql>alter sequence tag_id_seq increment by 50</sql>
    </changeSet>

    <changeSet id="dropWorkflowPath" author="agduncan">
        <dropColumn tableName="workflow" columnName="path"></dropColumn>
    </changeSet>

    <changeSet id="dropToolPath" author="agduncan">
        <dropColumn tableName="tool" columnName="path"></dropColumn>
    </changeSet>
</databaseChangeLog>
